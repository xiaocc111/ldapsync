# 简介
如果你的公司内部需要使用多种办公系统（Git、Jenkins、Rancher、Jumpserver、NAS等）或每台工位的电脑需要员工自己的用户密码，当公司里有上百人使用这些系统时，如何管理这些用户将成为问题，想象一下，新员工需要给他们创建用户分配权限、离职员工需要清理。

有没有一种办法可以让一个账号登录所有系统呢？想实现这种统一用户认证的方法有：sso、ldap、redius等，为什么我们要使用LDAP呢，就我个人的运维工作经验来说，一般这种企业内部系统都是自带ldap认证功能的，而redius不是所有系统都直接支持，有的产品的redius认证还需要额外付费，而支持使用token的sso认证方式的产品就更少了。

LDAP（Lightweight Directory Access Protocol，轻量级目录访问协议）是一种开放的、标准的、应用程序无关的协议，用于通过网络访问和管理分布式目录信息服务。它最初是为互联网设计的，目的是提供一种简化的方式来访问 X.500 目录服务，但比 X.500 更简单且更易于实现。

常见的 LDAP 实现
* OpenLDAP：一个开源的 LDAP 实现，广泛应用于 Unix 和 Linux 系统。
* Microsoft Active Directory：微软提供的目录服务，集成在 Windows Server 中，支持 LDAP 协议。
* Apache Directory Server：另一个开源的 LDAP 服务器实现，支持多种协议，包括 LDAP。


使用场景
* 企业用户管理和认证：很多企业使用 LDAP 来集中管理用户账户和权限。
* 邮件系统：邮件服务器通常依赖 LDAP 来查找收件人的地址信息。
* 单点登录（SSO）：一些 SSO 解决方案使用 LDAP 作为其用户认证的基础。

# 准备工作
以企业微信为例
你要先准备好一个LDAP的环境和一个企业微信

## 企业微信
1.可以在企业微信的开发者文档里找到获取token的接口

https://developer.work.weixin.qq.com/document/path/91039



2.需要在企业微信后台管理端里找到你的企业ID和企业微信通讯录的corpsecret，并让你的企业微信账号至少有通讯录的只读权限，这个步骤需要公司的企业微信最大权限的管理员配合完成

https://developer.work.weixin.qq.com/document/path/96252

## LDAP
需要部署一个LDAP服务器，可以使用OpenLDAP、Microsoft AD、群晖NAS的LDAP套件都可以，如果有群晖NAS推荐使用LDAP套件，因为它比其他LDAP有更直观更友好的UI管理界面，即使非运维人员也能轻松地完成配置。

部署好LDAP后需要添加个用户组`cn=users`

# 开始使用
**修改配置文件**

找到`e_wechat`里的`config.yaml`

在`ewechat`填写你的企业ID和通讯录secret，部门id填1可以获取所有用户信息

在`ldap`填写你的LDAP地址、管理员DN、管理员密码、基础DN



**执行程序**

执行企业微信的主程序`e_wechat/main.py`，启动程序后控制台会出现一个交互式界面，按照自己的需求输入相关的序号就可以了，直接输入7可以把当前企业微信的用户全部添加到LDAP中，如果有员工离职，可以输入4查看离职员工列表，输入5删除这些员工的账号

```
/*******/分割线/*******/
请输入序号（输入 q 退出程序）：
1.生成群晖LDAP导入所需的CSV文件；
2.直接在控制台查看所有用户信息（企业微信）；
3.只查看所有用户的关键信息和统计总数（名字、职位、手机号、邮箱）
4.查询离职员工（根据手机号）
5.删除离职员工（根据手机号）
6.查看公司重名的人
7.在OpenLDAP添加企业微信用户
请输入：
```



**注意事项**

* 程序根据每个员工的手机号字段和企业微信中每个数据的status字段来判断员工是否离职，请确保企业微信中所有员工中都填写了手机号，否则数据可能同步失败
* 请确保企业微信中所有员工中都填写了电子邮箱，否则员工会接收不到用户创建成功的邮件
